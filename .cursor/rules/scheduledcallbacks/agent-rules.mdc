---
alwaysApply: true
---

# Cursor Agent Rules

These rules guide AI agents to generate correct, safe Cadence transactions using Scheduled Callbacks.

## FlowCallbackScheduler Contract Reference

The **FlowCallbackScheduler** contract is located in [`../../../core-contracts/FlowCallbackScheduler.cdc`](../../../core-contracts/FlowCallbackScheduler.cdc) for easy reference.

> Use it directly as context when generating callback-related code to ensure accurate type definitions and interface implementations.

## Imports

Always use string imports:

```cadence
import "FungibleToken"
import "FlowCallbackScheduler"
```

## Required Params (Scheduled Callbacks)

- `timestamp: UFix64` (0 for immediate execution)
- `priority: UInt8` (0=High, 1=Medium, 2=Low)
- `executionEffort: UInt64` (minimum 10)
- `handlerStoragePath: StoragePath`
- `callbackData: AnyStruct?` (max 100 bytes)

## Transaction Skeleton (Scheduled Callbacks)

- Prepare:
  - Convert priority number to `FlowCallbackScheduler.Priority` enum.
  - Validate timestamp (future or 0 for immediate).
  - Estimate fees with `FlowCallbackScheduler.estimate()`.
  - Withdraw fees from user's FlowToken vault.
- Issue handler capability: `Capability<auth(FlowCallbackScheduler.Execute) &{FlowCallbackScheduler.CallbackHandler}>`.
- Execute:
  - Call `FlowCallbackScheduler.schedule()` with all parameters.
  - Optionally save `ScheduledCallback` receipt for future reference/cancellation.
- Post:
  - Verify callback scheduled successfully (check events or receipt ID).

## Prompt-to-Params Examples

- "Schedule callback to execute in 1 hour with high priority" →
  - `timestamp = getCurrentBlock().timestamp + 3600.0`
  - `priority = 0` (High)
  - `executionEffort = 1000` (moderate effort)
  - `handlerStoragePath` from user specification
  - `callbackData = nil` unless user provides specific data.

- "Schedule recurring payments every day for a week" →
  - Multiple callback transactions with `timestamp` incremented by 86400.0 (1 day)
  - `priority = 1` (Medium) for cost efficiency
  - `callbackData` containing payment details.

## Code Style

- Use named arguments.
- Prefer early returns and minimal nesting inside connector implementations (transactions use assertions instead).

## Sanity Checklist

- Imports present and string-based.
- Capability issuance and borrows succeed or `panic` with context.
- For scheduled callbacks: fee estimation before scheduling, timestamp validation, handler capability verification.
- For recurring callbacks: consider fee accumulation and batch scheduling efficiency.

## Development Guidelines

- Use string imports: `import "FlowCallbackScheduler"`, `import "FlowToken"`, `import "FungibleToken"`
- Emulator only; start with: `flow emulator --scheduled-callbacks`
- Estimate before schedule: `FlowCallbackScheduler.estimate(...)`
- Issue handler capability with correct entitlement: `auth(FlowCallbackScheduler.Execute) &{FlowCallbackScheduler.CallbackHandler}`
- Save `ScheduledCallback` if you will need to cancel later; call `FlowCallbackScheduler.cancel(callback: receipt)` to cancel

## Key Documentation

- **Index**: [`index.md`](./index.md) – Navigation and core contracts reference
- **Agent Rules**: [`agent-rules.mdc`](./agent-rules.mdc) – Cursor agent guidance for generating transactions
- **Quick Checklist**: [`quick-checklist.md`](./quick-checklist.md) – Essential implementation checklist
- **FLIP 330**: [`flip.md`](./flip.md) – Scheduled Callbacks specification and details
- **Workflows**:
    - [`workflows/callback-handler-workflow.md`](./workflows/callback-handler-workflow.md) – Implement a callback handler
    - [`workflows/callback-scheduling-workflow.md`](./workflows/callback-scheduling-workflow.md) – Schedule a callback